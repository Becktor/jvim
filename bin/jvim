#!/usr/bin/env bash
# jvim - Containerized Neovim launcher
# Usage: jvim [file|folder] [nvim args...]
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"

USER_UID=$(id -u)
USER_GID=$(id -g)
IMAGE="jvim:${USER_UID}"

# Detect host tmux version (for vim-tmux-navigator compatibility)
if command -v tmux &>/dev/null; then
    export TMUX_VERSION=$(tmux -V | sed 's/tmux //')
fi

# Build image if needed
build_if_needed() {
    if ! docker image inspect "$IMAGE" &>/dev/null; then
        echo "Building jvim image..."
        [[ -n "${TMUX_VERSION:-}" ]] && echo "Including tmux ${TMUX_VERSION} for vim-tmux-navigator..."
        export USER_UID USER_GID
        docker compose -f "$REPO_ROOT/docker/compose.yml" build
    fi
}

# Determine what to open
TARGET="${1:-}"
shift 2>/dev/null || true

if [[ -z "$TARGET" ]]; then
    MOUNT_DIR="$(pwd)"
    NVIM_ARGS=("$@")
elif [[ -f "$TARGET" ]]; then
    FULL_PATH="$(cd "$(dirname "$TARGET")" && pwd)/$(basename "$TARGET")"
    MOUNT_DIR="$(dirname "$FULL_PATH")"
    FILENAME="$(basename "$FULL_PATH")"
    NVIM_ARGS=("$FILENAME" "$@")
elif [[ -d "$TARGET" ]]; then
    MOUNT_DIR="$(cd "$TARGET" && pwd)"
    NVIM_ARGS=("$@")
else
    PARENT_DIR="$(cd "$(dirname "$TARGET")" 2>/dev/null && pwd || pwd)"
    FILENAME="$(basename "$TARGET")"
    MOUNT_DIR="$PARENT_DIR"
    NVIM_ARGS=("$FILENAME" "$@")
fi

build_if_needed

# Build volume mounts (nvim is the fixed username in container)
DOTFILES_PATH="${DOTFILES_PATH:-${HOME}/git/dotfiles}"

MOUNTS=(
    -v "$MOUNT_DIR":/home/nvim/workspace
    -v jvim-data:/home/nvim/.local/share/nvim
)

# Mount dotfiles if they exist
if [[ -d "${DOTFILES_PATH}/nvim" ]]; then
    MOUNTS+=(-v "${DOTFILES_PATH}/nvim":/home/nvim/.config/nvim)
    MOUNTS+=(-v "${DOTFILES_PATH}":/home/nvim/git/dotfiles)
fi

# Mount SSH if exists
[[ -d "${HOME}/.ssh" ]] && MOUNTS+=(-v "${HOME}/.ssh":/home/nvim/.ssh:ro)

# Mount gitconfig if exists
[[ -f "${HOME}/.gitconfig" ]] && MOUNTS+=(-v "${HOME}/.gitconfig":/home/nvim/.gitconfig:ro)

# Mount tmux socket for vim-tmux-navigator (nvim â†’ tmux navigation)
TMUX_VARS=()
if [[ -n "${TMUX:-}" ]]; then
    TMUX_SOCKET="${TMUX%%,*}"
    TMUX_SOCKET_DIR="$(dirname "$TMUX_SOCKET")"
    MOUNTS+=(-v "${TMUX_SOCKET_DIR}":"${TMUX_SOCKET_DIR}")
    TMUX_VARS+=(-e "TMUX=${TMUX}")
fi

# Run nvim (exec -a sets process name to "jvim" for vim-tmux-navigator detection)
exec -a jvim docker run --rm -it \
    "${MOUNTS[@]}" \
    ${TMUX_VARS[@]+"${TMUX_VARS[@]}"} \
    -w /home/nvim/workspace \
    -e HOST_UID="${USER_UID}" \
    -e HOST_GID="${USER_GID}" \
    -e TERM="${TERM:-xterm-256color}" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    "$IMAGE" \
    nvim "${NVIM_ARGS[@]}"
