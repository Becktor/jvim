#!/usr/bin/env bash
# jvim - Containerized Neovim launcher
# Usage: jvim [file|folder] [nvim args...]
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"

# Export host UID/GID and username
export USER_UID=$(id -u)
export USER_GID=$(id -g)
export USERNAME="${USERNAME:-nvim}"

# Build image if needed
build_if_needed() {
    if ! docker image inspect "jvim:${USER_UID}" &>/dev/null; then
        echo "Building jvim image for UID ${USER_UID}..."
        docker compose -f "$REPO_ROOT/docker/compose.yml" build
    fi
}

# Determine what to open
TARGET="${1:-}"
shift 2>/dev/null || true

if [[ -z "$TARGET" ]]; then
    # No arguments - open nvim in current directory
    MOUNT_DIR="$(pwd)"
    NVIM_ARGS=("$@")
elif [[ -f "$TARGET" ]]; then
    # It's a file - mount parent directory, open file
    FULL_PATH="$(cd "$(dirname "$TARGET")" && pwd)/$(basename "$TARGET")"
    MOUNT_DIR="$(dirname "$FULL_PATH")"
    FILENAME="$(basename "$FULL_PATH")"
    NVIM_ARGS=("$FILENAME" "$@")
elif [[ -d "$TARGET" ]]; then
    # It's a directory - mount it and open
    MOUNT_DIR="$(cd "$TARGET" && pwd)"
    NVIM_ARGS=("$@")
else
    # Doesn't exist yet - assume it's a new file
    PARENT_DIR="$(cd "$(dirname "$TARGET")" 2>/dev/null && pwd || pwd)"
    FILENAME="$(basename "$TARGET")"
    MOUNT_DIR="$PARENT_DIR"
    NVIM_ARGS=("$FILENAME" "$@")
fi

build_if_needed

# Build volume mounts
DOTFILES_PATH="${DOTFILES_PATH:-${HOME}/git/dotfiles}"

MOUNTS=(
    -v "$MOUNT_DIR":/home/${USERNAME}/workspace
    -v jvim-data:/home/${USERNAME}/.local/share/nvim
)

# Only mount dotfiles if they exist on host
if [[ -d "${DOTFILES_PATH}/nvim" ]]; then
    MOUNTS+=(-v "${DOTFILES_PATH}/nvim":/home/${USERNAME}/.config/nvim)
    MOUNTS+=(-v "${DOTFILES_PATH}":/home/${USERNAME}/git/dotfiles)
fi

# Mount SSH if exists
[[ -d "${HOME}/.ssh" ]] && MOUNTS+=(-v "${HOME}/.ssh":/home/${USERNAME}/.ssh:ro)

# Mount gitconfig if exists and is a file
[[ -f "${HOME}/.gitconfig" ]] && MOUNTS+=(-v "${HOME}/.gitconfig":/home/${USERNAME}/.gitconfig:ro)

# Run nvim with the mounted directory
exec docker run --rm -it \
    "${MOUNTS[@]}" \
    -w /home/${USERNAME}/workspace \
    -e TERM="${TERM:-xterm-256color}" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    "jvim:${USER_UID}" \
    nvim "${NVIM_ARGS[@]}"
