#!/usr/bin/env bash
# jvim - Containerized Neovim launcher
# Usage: jvim [file|folder] [nvim args...]

# Re-exec with "jvim" as process name for tmux/ps display
if [[ -z "${JVIM_REEXEC:-}" ]]; then
    export JVIM_REEXEC=1
    exec -a jvim bash "${BASH_SOURCE[0]}" "$@"
fi

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"

# Export host UID/GID and username
export USER_UID=$(id -u)
export USER_GID=$(id -g)
export USERNAME="${USERNAME:-nvim}"

# Build image if needed
build_if_needed() {
    if ! docker image inspect "jvim:${USER_UID}" &>/dev/null; then
        echo "Building jvim image for UID ${USER_UID}..."
        docker compose -f "$REPO_ROOT/docker/compose.yml" build
    fi
}

# Determine what to open
TARGET="${1:-}"
shift 2>/dev/null || true

if [[ -z "$TARGET" ]]; then
    # No arguments - open nvim in current directory
    MOUNT_DIR="$(pwd)"
    NVIM_ARGS=("$@")
elif [[ -f "$TARGET" ]]; then
    # It's a file - mount parent directory, open file
    FULL_PATH="$(cd "$(dirname "$TARGET")" && pwd)/$(basename "$TARGET")"
    MOUNT_DIR="$(dirname "$FULL_PATH")"
    FILENAME="$(basename "$FULL_PATH")"
    NVIM_ARGS=("$FILENAME" "$@")
elif [[ -d "$TARGET" ]]; then
    # It's a directory - mount it and open
    MOUNT_DIR="$(cd "$TARGET" && pwd)"
    NVIM_ARGS=("$@")
else
    # Doesn't exist yet - assume it's a new file
    PARENT_DIR="$(cd "$(dirname "$TARGET")" 2>/dev/null && pwd || pwd)"
    FILENAME="$(basename "$TARGET")"
    MOUNT_DIR="$PARENT_DIR"
    NVIM_ARGS=("$FILENAME" "$@")
fi

build_if_needed

# Build volume mounts
NVIM_CONFIG_PATH="${NVIM_CONFIG_PATH:-${HOME}/git/dotfiles/dev-env/nvim}"
WORKDIR_NAME="$(basename "$MOUNT_DIR")"

MOUNTS=(
    -v "$MOUNT_DIR":/home/${USERNAME}/${WORKDIR_NAME}
    -v jvim-data:/home/${USERNAME}/.local/share/nvim
)

# Only mount nvim config if it exists on host
if [[ -d "${NVIM_CONFIG_PATH}" ]]; then
    MOUNTS+=(-v "${NVIM_CONFIG_PATH}":/home/${USERNAME}/.config/nvim)
fi

# Mount SSH if exists
[[ -d "${HOME}/.ssh" ]] && MOUNTS+=(-v "${HOME}/.ssh":/home/${USERNAME}/.ssh:ro)

# Mount gitconfig if exists and is a file
[[ -f "${HOME}/.gitconfig" ]] && MOUNTS+=(-v "${HOME}/.gitconfig":/home/${USERNAME}/.gitconfig:ro)

# Mount tmux socket for vim-tmux-navigator integration
TMUX_VARS=()
if [[ -n "${TMUX:-}" ]]; then
    # Extract socket path from TMUX env var (format: /path/to/socket,pid,pane)
    TMUX_SOCKET="${TMUX%%,*}"
    TMUX_SOCKET_DIR="$(dirname "$TMUX_SOCKET")"
    MOUNTS+=(-v "${TMUX_SOCKET_DIR}":"${TMUX_SOCKET_DIR}")
    TMUX_VARS+=(-e "TMUX=${TMUX}")
fi

# Run nvim with the mounted directory
docker run --rm -it \
    "${MOUNTS[@]}" \
    ${TMUX_VARS[@]+"${TMUX_VARS[@]}"} \
    -w /home/${USERNAME}/${WORKDIR_NAME} \
    -e TERM="${TERM:-xterm-256color}" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    "jvim:${USER_UID}" \
    nvim "${NVIM_ARGS[@]}"
